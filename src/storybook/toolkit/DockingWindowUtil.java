/*
 Storybook: Open Source software for novelists and authors.
 Copyright (C) 2008 - 2012 Martin Mustun

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package storybook.toolkit;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;

import net.infonode.docking.DockingWindow;
import net.infonode.docking.RootWindow;
import net.infonode.docking.TabWindow;
import net.infonode.docking.View;
import net.infonode.docking.WindowBar;
import net.infonode.docking.properties.TabWindowProperties;
import net.infonode.docking.util.StringViewMap;
import org.apache.commons.codec.DecoderException;

import org.apache.commons.codec.binary.Hex;
import org.apache.commons.codec.digest.DigestUtils;

import storybook.SbApp;
import storybook.SbConstants.PreferenceKey;
import storybook.SbConstants.ViewName;
import storybook.controller.BookController;
import storybook.model.hbn.entity.Preference;
import storybook.ui.panel.AbstractPanel;
import storybook.ui.MainFrame;
import storybook.ui.SbView;
import storybook.ui.ViewFactory;

/**
 * @author martin
 *
 */
public class DockingWindowUtil {

	private static boolean trace = false;
	public final static String DEFAULT_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000010000001a000000020000000301000000020000000400000000020000000500000000020000000600000000020000000700000000020000000801000000020000000901000000020000000a01000000020000000b00000000020000000c00000000020000000d00000000020000000e00000000020000000f00000000027a000001490000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000000010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffffffffffffffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffffffffffffffffffffffffffffffffffff";
	public final static String PERSONS_LOCATIONS_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000000000000200000000000000020000000100000019000000020000000300000000020000000400000000020000000500000000020000000600000000020000000700000000020000000800000000020000000901000000020000000b00000000020000000c01000000020000000d01000000020000000e000000000200007a00000197000f00000000020000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000006010000000100000000ffffffffffffffff00013f00e638ffffffff000000000100000001000000020000000a01ffffffffffffffff01003f0064d3ffffffff010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffffffffffffffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000ffffffffffffffffffffffffffffffffffffffffffffffff";
	public final static String TAGS_ITEMS_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff0100000000000000020000000000000002000000000000000100000000000000020000000100000017000000020000000300000000020000000400000000020000000500000000020000000600000000020000000700000000020000000800000000020000000900000000020000000b00000000020000000c00000000020000000d00000000020000007a000001a90e00000000020000000f00000000020000001000000000020000001101000000020000001201000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff0000000d010000000100000002000000020000001301000000020000001401ffffffff0000000001003efba5c9ffffffff01013f00e638ffffffff000000000100000001000000020000000a00ffffffffffffffff00003f0064d3ffffffff000000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffffffffffffffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000ffffffffffffffff00000000ffffffffffffffffffffffff";
	public final static String CHRONO_ONLY_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000010000001a000000020000000301000000020000000400000000020000000500000000020000000600000000020000000700000000020000000800000000020000000900000000020000000a00000000020000000b00000000020000000c00000000020000000d00000000020000000e00000000020000000f00000000027a0000013d0000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000000010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffffffffffffffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffffffffffff";
	public final static String BOOK_ONLY_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000010000001a000000020000000300000000020000000401000000020000000500000000020000000600000000020000000700000000020000000800000000020000000900000000020000000a00000000020000000b00000000020000000c00000000020000000d00000000020000000e00000000020000000f00000000027a0000013d0000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000001010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffff00000000ffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffffffffffff";
	public final static String MANAGE_ONLY_LAYOUT =  "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000010000001a000000020000000300000000020000000400000000020000000501000000020000000600000000020000000700000000020000000800000000020000000900000000020000000a00000000020000000b00000000020000000c00000000020000000d00000000020000000e00000000020000000f00000000027a0000013d0000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000002010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffff00000000ffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
	public final static String READING_ONLY_LAYOUT = "aced00057a0000040000000004000000001e00000011aced0005770b01000454726565ffffffff00000011aced0005770b010004496e666fffffffff00000017aced0005771101000a4e617669676174696f6effffffff00000013aced0005770d0100064368726f6e6fffffffff00000011aced0005770b010004426f6f6bffffffff00000013aced0005770d0100064d616e616765ffffffff00000014aced0005770e01000752656164696e67ffffffff00000014aced0005770e0100074d656d6f726961ffffffff00000013aced0005770d0100065363656e6573ffffffff00000014aced0005770e010007506572736f6e73ffffffff00000016aced000577100100094c6f636174696f6e73ffffffff00000015aced0005770f0100084368617074657273ffffffff00000014aced0005770e01000747656e64657273ffffffff00000017aced0005771101000a43617465676f72696573ffffffff00000012aced0005770c0100055061727473ffffffff00000014aced0005770e010007537472616e6473ffffffff00000012aced0005770c0100054964656173ffffffff00000011aced0005770b01000454616773ffffffff00000012aced0005770c0100054974656d73ffffffff00000015aced0005770f0100085461674c696e6b73ffffffff00000016aced000577100100094974656d4c696e6b73ffffffff00000016aced00057710010009496e7465726e616c73ffffffff0000001faced000577190100124368617274506572736f6e73427944617465ffffffff00000020aced0005771a0100134368617274506572736f6e7342795363656e65ffffffff00000016aced00057710010009436861727457695757ffffffff0000001faced000577190100124368617274537472616e6473427944617465ffffffff00000025aced0005771f01001843686172744f6363757272656e63654f66506572736f6e73ffffffff00000027aced0005772101001a43686172744f6363757272656e63654f664c6f636174696f6e73ffffffff00000017aced0005771101000a436861727447616e7474ffffffff00000013aced0005770d010006456469746f720000000100000001000000000000000200000000000000020000000100000001000000020000000001ffffffffffffffff010000000100000002000000020000000101000000020000000201ffffffff0000000001003f19999affffffff010000000000000002000000010000001a000000020000000300000000020000000400000000020000000500000000020000000601000000020000000700000000020000000800000000020000000900000000020000000a00000000020000000b00000000020000000c00000000020000000d00000000020000000e00000000020000000f00000000027a0000013d0000001000000000020000001100000000020000001200000000020000001300000000020000001400000000020000001500000000020000001600000000020000001700000000020000001800000000020000001900000000020000001a00000000020000001b00000000020000001c00ffffffff00000003010000000100000001000000020000001d00ffffffffffffffff00013f19999affffffff00013e4ccccdffffffff01ffffffff01000000c800ffffffffffffffff00000000000001cc01ffffffffffffffff00000001000000010000001d000000c800ffffffffffffffff00000000000000c800ffffffffffffffff000000000000000000000004ffffffff00000000ffffffffffffffffffffffff00000001ffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffffffffffff";

	public static void setRespectMinimumSize(MainFrame mainFrame) {
		SbView[] views = new SbView[2];
		views[0] = mainFrame.getView(ViewName.EDITOR);
		views[1] = mainFrame.getView(ViewName.TREE);
		for (SbView view : views) {
			DockingWindow win = view.getWindowParent();
			if (win == null) {
				continue;
			}
			if (win instanceof TabWindow) {
				TabWindowProperties props = new TabWindowProperties();
				props.setRespectChildWindowMinimumSize(true);
				((TabWindow) win).getTabWindowProperties().addSuperObject(props);
			} else if (win instanceof WindowBar) {
				// can't be set for a WindowBar
			}
		}
	}

	public static void setLayout(MainFrame mainFrame, String hex) {
		try {
			mainFrame.setWaitingCursor();
			byte[] ba = Hex.decodeHex(hex.toCharArray());
			ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(ba));
			RootWindow rootWindow = mainFrame.getRootWindow();
			rootWindow.read(in, true);
			in.close();
			setRespectMinimumSize(mainFrame);
			unloadHiddenViews(mainFrame);
			/* suppression du garbage collector
			 SbApp.getInstance().runGC();
			 */
			mainFrame.setDefaultCursor();
		} catch (DecoderException | IOException e) {
		}
	}

	public static void unloadHiddenViews(MainFrame mainFrame) {
		ViewFactory viewFactory = mainFrame.getViewFactory();
		StringViewMap viewMap = viewFactory.getViewMap();
		BookController documentCtrl = mainFrame.getBookController();
		int c = viewMap.getViewCount();
		for (int i = 0; i < c; ++i) {
			View view = viewMap.getViewAtIndex(i);
			if (view instanceof SbView) {
				SbView sbView = (SbView) view;
				if (sbView.isWindowShowing()) {
					// window is showing
					if (!sbView.isLoaded()) {
						viewFactory.loadView(sbView);
						documentCtrl.attachView((AbstractPanel) view.getComponent());
					}
				} else {
					// window is not showing
					if (sbView.isLoaded()) {
						documentCtrl.detachView((AbstractPanel) view.getComponent());
						viewFactory.unloadView(sbView);
					}
				}
			}
		}
	}

	public static void saveLayout(MainFrame mainFrame, String name) {
		try {
			RootWindow rootWindow = mainFrame.getRootWindow();
			ByteArrayOutputStream bos = new ByteArrayOutputStream();
			ObjectOutputStream out = new ObjectOutputStream(bos);
			rootWindow.write(out, false);
			out.close();
			byte[] ba = bos.toByteArray();

			if (trace) {
				String hexString = new String(Hex.encodeHex(ba));
				System.out.println("DockingWindowUtil.saveLayout(): hex ----------:\n"+ hexString);
				// byte[] ba2= Hex.decodeHex(hexString.toCharArray());
				System.out.println("DockingWindowUtil.saveLayout(): ----------\n");
			}
			String strKey = getStrKey(name);
			PrefUtil.set(strKey, name);
			PrefUtil.set(strKey, ba);
			// PrefUtil.dump();
			SbApp.getInstance().reloadMenuBars();
			SbApp.getInstance().reloadStatusBars();
		} catch (Exception e) {
		}
	}

	public static boolean loadLayout(MainFrame mainFrame, String name) {
		try {
			Preference pref = PrefUtil.get(getStrKey(name), null);
			if (pref == null) {
				return false;
			}
			mainFrame.setWaitingCursor();
			byte[] ba = pref.getBinValue();
			ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(ba));
			RootWindow rootWindow = mainFrame.getRootWindow();
			rootWindow.read(in, true);
			in.close();
			setRespectMinimumSize(mainFrame);
			unloadHiddenViews(mainFrame);
			/* suppression du garbage collector
			 SbApp.getInstance().runGC();
			 */
			mainFrame.setDefaultCursor();
			return true;
		} catch (Exception e) {
			System.err.println("*** DockingWindowUtil.loadLoayout(" + mainFrame.getName()
				+ ","+name+") Exception :"+e.getMessage());
		}
		return false;
	}

	public static String getStrKey(String name) {
		String ret = DigestUtils.md5Hex(name);
		return PreferenceKey.DOCKING_LAYOUT.toString() + "_" + ret;
	}
}
